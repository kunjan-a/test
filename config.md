## Maintaining configurations for different environments

### Providing config:
 * Configurations for all environments are stored as a JSONObject inside assets/config/config.js


---

### Adding new config environment:
 * Add the environment name to `environments` array inside [config.js][config-file]
 * For every property that you want to modify in that environment provide a value with the environment's name.


---

### Specifying configuration properties:
 * All configuration properties are specified inside `config` element of [config.js][config-file]

#### Property value is same for all environments:
 * There is no need to mention any environment and the value can be specified directly:
    * "file_sharing_uri": "https://fs.talk.to/filesharing/"


#### Property value is different for certain environments:
 * Specify the property value as a JSONObject.
 * Mention a `default` value which will be used by all environments.
 * For environments where the value is different, mention the environment name as `key` while specifying the value:
    * "group_tracking_id": {
                  "default": "UA-47036266-10",
                  "prod": "UA-45883289-3"
              }


---

### Generating properties files:
 * Properties files are generated by the python script [config_generator.py][config-generator]

#### From command line:
 * Run this command from gandalf/app:
    * `../scripts/config_generator.py -i assets/config/config.js -o assets/config`

#### From IDE:
 * You should install the plugin `Python Community Edition`.
 * Inside `Project Structure` add path to your python installation under `SDKs`
 * `gandalf/scripts` is added as a python module in the project. 
 * Also a run/debug python configuration is present with the name `config_generator` in the project.
 * Ensure that `Python interpreter` is configured correctly.


---

### Setting the app config
 * App reads it configuration from the properties file : `goto.properties`
 * This file needs to have an additional property `app.build_date`, set as the date on which build is being made.

### Generating app config:
 * `goto.properties` properties files is generated by the python script [configSetter.py][config-setter]

#### From command line:
 * Run this command from gandalf/app to set alpha as the app property:
    * `../scripts/configSetter.py -e alpha -c app/assets/config -d app.build_date -o goto`

#### From IDE:
 * You should install the plugin `Python Community Edition`.
 * Inside `Project Structure` add path to your python installation under `SDKs`
 * `gandalf/scripts` is added as a python module in the project.
 * Also a run/debug python configuration is present with the name `config setter alpha` in the project.
 * Ensure that `Python interpreter` is configured correctly.


---

### Build version labelling
 * Each new build needs to have an increasing version code.
 * Version name is also specified but its only user facing and android or play store dont care about the value or its format.

#### Finding the appropriate name and version code:
 * Set commit count as version code
    * git rev-list HEAD -—count

#### Finding version name:
 * Git describe does this beautifully.
 * It gives last tag with commits post that tag and hashcode of the last commit
    * git describe --tags --match "v[0-9]*" --long
    * -—tags: Instead of using only the annotated tags, use any tag found in refs/tags namespace. This option enables matching a lightweight (non-annotated) tag.
    * -—long: even when the commit in question happens to be a tagged version. Instead of just emitting the tag name, it will describe such a commit as v1.2-5-gdeadbe (5th commit since tag v1.2 that points at object gdeadbe.)
    * —-match: Only consider tags matching the given glob(7) pattern, excluding the "refs/tags/" prefix. This can be used to avoid leaking private tags from the repository.
 * The output is:
    * <tagname>-<number of commits since that tag>-<first few characters of last commit’s hash> 
    * It gives last tag with count of commits post that tag and hashcode of the last commit.

 * Version name:
    * market: remove everything after the second last hyphen (even the hyphen) from output of ‘git describe’. Suffix with '.<version code>' e.g: v1.2.124
    * others: replace tagname in output of ‘git describe’ wih market version name, and suffix the o/p with build type. e.g. for alpha: v1.2-124-0-gdeadbe-alpha


---

### Generating build version labels:
 * Build version code and version are generated by the python script [versionSetter.py][version-setter]


#### From command line:
 * Run this command from gandalf/app to set alpha as the app property:
    * `../scripts/versionSetter.py -m app/AndroidManifest.xml -t alpha`

#### From IDE:
 * You should install the plugin `Python Community Edition`.
 * Inside `Project Structure` add path to your python installation under `SDKs`
 * `gandalf/scripts` is added as a python module in the project.
 * Also a run/debug python configuration is present with the name `version setter alpha` in the project.
 * Ensure that `Python interpreter` is configured correctly.

---

### Deciding which configuration to use

#### Market configuration
 * To be built from master branch
 * Points to production environment
 * All runtime exceptions are reported as crashes on crittercism
 * All error logs are reported as handled exceptions on crittercism
 * Used for publishing on Google Play Store for market users
 
 
#### Beta configuration
 * To be built from develop branch
 * Points to production environment
 * All runtime exceptions are reported as crashes on crittercism
 * All error logs are reported as handled exceptions on crittercism
 * Used for publishing on Google Play Store for beta community
 

#### Alpha configuration
 * To be built from develop branch
 * Points to production environment
 * All runtime exceptions are reported as crashes on crittercism
 * All error logs are reported as handled exceptions on crittercism
 * Used for publishing on Google Play Store for alpha community
 

#### QA configuration
 * To be built from develop/feature/fixes branch
 * Points to staging environment
 * All runtime exceptions are reported as crashes on crittercism
 * All error logs are reported as handled exceptions on crittercism
 * Useful for qa to validate develop/feature/fixes branches while accepting pivotal tasks
 

#### DEV configuration
 * To be built from develop/feature/fixes branch
 * Points to staging environment
 * All runtime exceptions cause app to crash
 * All error logs cause app to crash
 * To be used by devs while working on develop branch or their own personal branches
 

---

[config-file]: https://github.com/talk-to/gandalf/blob/master/app/assets/config/config.js
[config-generator]: https://github.com/talk-to/gandalf/blob/master/scripts/config_generator.py
[config-setter]: https://github.com/talk-to/gandalf/blob/master/scripts/configSetter.py
[version-setter]: https://github.com/talk-to/gandalf/blob/master/scripts/versionSetter.py

